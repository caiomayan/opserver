<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste CorreÃ§Ã£o VPN Main Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">ğŸ”§ Teste: CorreÃ§Ã£o VPN que Desaparece</h1>
        
        <!-- Status do Teste -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š Status do Teste</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-gray-700 rounded p-4 text-center">
                    <h4 class="font-medium mb-2">Sistema Carregado</h4>
                    <div id="system-status" class="text-sm">â³ Verificando...</div>
                </div>
                <div class="bg-gray-700 rounded p-4 text-center">
                    <h4 class="font-medium mb-2">VPN Detectado</h4>
                    <div id="vpn-detection-status" class="text-sm">â³ Aguardando...</div>
                </div>
                <div class="bg-gray-700 rounded p-4 text-center">
                    <h4 class="font-medium mb-2">Indicador Persistente</h4>
                    <div id="persistence-status" class="text-sm">â³ Monitorando...</div>
                </div>
            </div>
        </div>
        
        <!-- SimulaÃ§Ã£o da PÃ¡gina Principal -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ SimulaÃ§Ã£o Main Page</h2>
            
            <!-- Elementos iguais aos da main.html -->
            <div class="text-center">
                <div id="server-count-display" class="text-6xl font-bold text-green-400 mb-4">01</div>
                <div class="text-sm text-gray-400 mb-2">Servidores Online</div>
                <div class="mt-6 flex justify-center">
                    <div id="main-server-status-dot" class="w-2 h-2 bg-gray-400 rounded-full transition-colors duration-300"></div>
                </div>
                
                <!-- VPN Indicator - exato como na main.html -->
                <div id="main-vpn-indicator" class="mt-4 flex items-center justify-center space-x-1 text-xs text-amber-500 opacity-0 transition-opacity duration-300" style="display: none;">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    <span>Servidor VPN</span>
                </div>
                
                <!-- Dados de debug -->
                <div class="mt-4 text-xs text-gray-400">
                    <div>Estado Indicador: <span id="indicator-state">Oculto</span></div>
                    <div>Attribute VPN: <span id="vpn-attribute">NÃ£o definido</span></div>
                    <div>Ãšltimo Status: <span id="last-status">Nenhum</span></div>
                </div>
            </div>
        </div>
        
        <!-- Controles de Teste -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ® Controles de Teste</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <button id="test-vpn-detection" class="bg-amber-500 hover:bg-amber-600 px-4 py-2 rounded">
                    ğŸ”Œ Simular VPN
                </button>
                <button id="test-status-updates" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded">
                    ğŸ“¡ Simular Updates
                </button>
                <button id="test-persistence" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded">
                    â° Teste PersistÃªncia
                </button>
                <button id="reset-test" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                    ğŸ”„ Reset
                </button>
            </div>
            
            <div class="text-center">
                <div id="test-result" class="text-lg font-semibold">â³ Escolha um teste para iniciar</div>
            </div>
        </div>
        
        <!-- Log de Monitoramento -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ Log de Monitoramento</h2>
            <div id="monitoring-log" class="bg-black rounded p-4 font-mono text-xs text-green-400 h-48 overflow-y-auto whitespace-pre-wrap"></div>
            <div class="mt-2 text-center">
                <button id="clear-log" class="bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded text-sm">Limpar Log</button>
            </div>
        </div>
    </div>

    <!-- Scripts necessÃ¡rios -->
    <script src="./src/server-cache.js"></script>
    <script type="module" src="./src/cs2-server-status.js"></script>
    
    <script>
        let monitoringLog = [];
        let monitoringInterval = null;
        let testCount = 0;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            monitoringLog.push(logEntry);
            
            const logElement = document.getElementById('monitoring-log');
            logElement.textContent = monitoringLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }
        
        function updateIndicatorStatus() {
            const indicator = document.getElementById('main-vpn-indicator');
            const isVisible = indicator.style.display === 'flex';
            const opacity = indicator.style.opacity;
            const vpnAttribute = indicator.getAttribute('data-vpn-detected');
            
            document.getElementById('indicator-state').textContent = isVisible ? `VisÃ­vel (opacity: ${opacity})` : 'Oculto';
            document.getElementById('vpn-attribute').textContent = vpnAttribute || 'NÃ£o definido';
            
            return isVisible;
        }
        
        function startMonitoring() {
            if (monitoringInterval) return;
            
            log('ğŸ” Iniciando monitoramento do indicador VPN...');
            
            monitoringInterval = setInterval(() => {
                const isVisible = updateIndicatorStatus();
                const timestamp = new Date().toLocaleTimeString();
                
                // Log sÃ³ se houve mudanÃ§a de estado
                const lastState = window.lastIndicatorState;
                if (lastState !== isVisible) {
                    log(`ğŸ“Š Indicador VPN ${isVisible ? 'VISÃVEL' : 'OCULTO'} Ã s ${timestamp}`);
                    window.lastIndicatorState = isVisible;
                }
            }, 1000);
        }
        
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                log('â¹ï¸ Monitoramento parado');
            }
        }
        
        // Teste de detecÃ§Ã£o VPN
        document.getElementById('test-vpn-detection').addEventListener('click', async () => {
            log('ğŸ”Œ TESTE: Simulando detecÃ§Ã£o VPN...');
            document.getElementById('test-result').innerHTML = '<span class="text-blue-400">ğŸ”„ Testando detecÃ§Ã£o VPN...</span>';
            
            try {
                // Check if system is available
                if (!window.cs2ServerStatus) {
                    throw new Error('CS2ServerStatus nÃ£o disponÃ­vel');
                }
                
                // Force VPN detection
                const vpnData = {
                    status: 'vpn',
                    name: 'A GREAT CHAOS 01',
                    isVpnServer: true
                };
                
                log('1. Chamando updateVpnIndicators...');
                window.cs2ServerStatus.updateVpnIndicators(vpnData);
                
                log('2. Disparando evento vpnServerDetected...');
                document.dispatchEvent(new CustomEvent('vpnServerDetected', { detail: vpnData }));
                
                log('3. Disparando evento serverStatusUpdate...');
                window.dispatchEvent(new CustomEvent('serverStatusUpdate', { detail: vpnData }));
                
                // Wait and check
                await new Promise(resolve => setTimeout(resolve, 500));
                const isVisible = updateIndicatorStatus();
                
                if (isVisible) {
                    document.getElementById('test-result').innerHTML = '<span class="text-green-400">âœ… VPN detectado e indicador ativo</span>';
                    document.getElementById('vpn-detection-status').innerHTML = '<span class="text-green-400">âœ… Detectado</span>';
                    log('âœ… SUCESSO: Indicador VPN ativado');
                } else {
                    document.getElementById('test-result').innerHTML = '<span class="text-red-400">âŒ Falhou: Indicador nÃ£o apareceu</span>';
                    log('âŒ FALHA: Indicador VPN nÃ£o foi ativado');
                }
                
            } catch (error) {
                log(`âŒ ERRO: ${error.message}`);
                document.getElementById('test-result').innerHTML = `<span class="text-red-400">âŒ Erro: ${error.message}</span>`;
            }
        });
        
        // Teste de mÃºltiplas atualizaÃ§Ãµes
        document.getElementById('test-status-updates').addEventListener('click', async () => {
            log('ğŸ“¡ TESTE: Simulando mÃºltiplas atualizaÃ§Ãµes de status...');
            document.getElementById('test-result').innerHTML = '<span class="text-blue-400">ğŸ”„ Testando atualizaÃ§Ãµes mÃºltiplas...</span>';
            
            try {
                if (!window.cs2ServerStatus) {
                    throw new Error('CS2ServerStatus nÃ£o disponÃ­vel');
                }
                
                // First: VPN detection
                const vpnData = { status: 'vpn', name: 'A GREAT CHAOS 01', isVpnServer: true };
                log('1. Enviando status VPN...');
                window.cs2ServerStatus.updateVpnIndicators(vpnData);
                window.dispatchEvent(new CustomEvent('serverStatusUpdate', { detail: vpnData }));
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Second: Unknown status (this used to hide the indicator)
                const unknownData = { status: 'unknown', name: 'A GREAT CHAOS 01' };
                log('2. Enviando status unknown (teste crÃ­tico)...');
                window.dispatchEvent(new CustomEvent('serverStatusUpdate', { detail: unknownData }));
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Third: Checking status
                const checkingData = { status: 'checking', name: 'A GREAT CHAOS 01' };
                log('3. Enviando status checking...');
                window.dispatchEvent(new CustomEvent('serverStatusUpdate', { detail: checkingData }));
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check final state
                const isVisible = updateIndicatorStatus();
                
                if (isVisible) {
                    document.getElementById('test-result').innerHTML = '<span class="text-green-400">âœ… Indicador persistiu atravÃ©s das atualizaÃ§Ãµes</span>';
                    document.getElementById('persistence-status').innerHTML = '<span class="text-green-400">âœ… Persistente</span>';
                    log('âœ… SUCESSO: Indicador VPN permaneceu visÃ­vel');
                } else {
                    document.getElementById('test-result').innerHTML = '<span class="text-red-400">âŒ Indicador desapareceu durante atualizaÃ§Ãµes</span>';
                    document.getElementById('persistence-status').innerHTML = '<span class="text-red-400">âŒ NÃ£o persistente</span>';
                    log('âŒ FALHA: Indicador VPN desapareceu');
                }
                
            } catch (error) {
                log(`âŒ ERRO: ${error.message}`);
                document.getElementById('test-result').innerHTML = `<span class="text-red-400">âŒ Erro: ${error.message}</span>`;
            }
        });
        
        // Teste de persistÃªncia ao longo do tempo
        document.getElementById('test-persistence').addEventListener('click', async () => {
            log('â° TESTE: Verificando persistÃªncia ao longo do tempo...');
            document.getElementById('test-result').innerHTML = '<span class="text-blue-400">ğŸ”„ Testando persistÃªncia (30s)...</span>';
            
            try {
                if (!window.cs2ServerStatus) {
                    throw new Error('CS2ServerStatus nÃ£o disponÃ­vel');
                }
                
                // Activate VPN
                const vpnData = { status: 'vpn', name: 'A GREAT CHAOS 01', isVpnServer: true };
                window.cs2ServerStatus.updateVpnIndicators(vpnData);
                window.dispatchEvent(new CustomEvent('serverStatusUpdate', { detail: vpnData }));
                
                log('VPN ativado, monitorando por 30 segundos...');
                
                let checks = 0;
                let visibleChecks = 0;
                
                const persistenceTest = setInterval(() => {
                    checks++;
                    const isVisible = updateIndicatorStatus();
                    
                    if (isVisible) {
                        visibleChecks++;
                    }
                    
                    log(`Check ${checks}/30: Indicador ${isVisible ? 'VISÃVEL' : 'OCULTO'}`);
                    
                    // Send random status updates to test persistence
                    const statuses = ['unknown', 'checking', 'vpn'];
                    const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                    const testData = { status: randomStatus, name: 'A GREAT CHAOS 01' };
                    
                    if (randomStatus !== 'vpn') {
                        window.dispatchEvent(new CustomEvent('serverStatusUpdate', { detail: testData }));
                    }
                    
                    if (checks >= 30) {
                        clearInterval(persistenceTest);
                        
                        const persistenceRate = (visibleChecks / checks) * 100;
                        
                        if (persistenceRate >= 90) {
                            document.getElementById('test-result').innerHTML = '<span class="text-green-400">âœ… Indicador altamente persistente (' + persistenceRate.toFixed(1) + '%)</span>';
                            document.getElementById('persistence-status').innerHTML = '<span class="text-green-400">âœ… Altamente persistente</span>';
                            log(`âœ… SUCESSO: PersistÃªncia de ${persistenceRate.toFixed(1)}%`);
                        } else {
                            document.getElementById('test-result').innerHTML = '<span class="text-yellow-400">âš ï¸ PersistÃªncia moderada (' + persistenceRate.toFixed(1) + '%)</span>';
                            document.getElementById('persistence-status').innerHTML = '<span class="text-yellow-400">âš ï¸ Moderada</span>';
                            log(`âš ï¸ AVISO: PersistÃªncia de apenas ${persistenceRate.toFixed(1)}%`);
                        }
                    }
                }, 1000);
                
            } catch (error) {
                log(`âŒ ERRO: ${error.message}`);
                document.getElementById('test-result').innerHTML = `<span class="text-red-400">âŒ Erro: ${error.message}</span>`;
            }
        });
        
        // Reset
        document.getElementById('reset-test').addEventListener('click', () => {
            log('ğŸ”„ Resetando teste...');
            
            const indicator = document.getElementById('main-vpn-indicator');
            indicator.style.display = 'none';
            indicator.style.opacity = '0';
            indicator.removeAttribute('data-vpn-detected');
            
            document.getElementById('test-result').textContent = 'â³ Teste resetado';
            document.getElementById('vpn-detection-status').innerHTML = '<span class="text-gray-400">â³ Aguardando...</span>';
            document.getElementById('persistence-status').innerHTML = '<span class="text-gray-400">â³ Monitorando...</span>';
            
            updateIndicatorStatus();
            log('âœ… Reset completo');
        });
        
        // Clear log
        document.getElementById('clear-log').addEventListener('click', () => {
            monitoringLog = [];
            document.getElementById('monitoring-log').textContent = '';
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ Teste de correÃ§Ã£o VPN iniciado');
            updateIndicatorStatus();
            startMonitoring();
            
            // Check system availability
            setTimeout(() => {
                if (window.cs2ServerStatus) {
                    log('âœ… CS2ServerStatus disponÃ­vel');
                    document.getElementById('system-status').innerHTML = '<span class="text-green-400">âœ… DisponÃ­vel</span>';
                } else {
                    log('âŒ CS2ServerStatus nÃ£o disponÃ­vel');
                    document.getElementById('system-status').innerHTML = '<span class="text-red-400">âŒ NÃ£o disponÃ­vel</span>';
                }
            }, 1500);
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopMonitoring();
        });
    </script>
</body>
</html>
